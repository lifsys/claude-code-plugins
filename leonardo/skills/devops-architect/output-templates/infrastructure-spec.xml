<?xml version="1.0" encoding="UTF-8"?>
<!--
  Infrastructure Specification Template
  Generated by: DevOps-Architect (Leonardo Plugin)

  This template extends Leonardo's project_specification.xml with
  comprehensive infrastructure and deployment configuration.
-->

<infrastructure_specification>
  <metadata>
    <generated_date>YYYY-MM-DD</generated_date>
    <generator>devops-architect v1.0</generator>
    <project_name><!-- Project name from project_specification --></project_name>
  </metadata>

  <!-- Requirements extracted from project specification -->
  <requirements_summary>
    <scale_tier><!-- MVP | Growth | Scale | Enterprise --></scale_tier>
    <budget_monthly><!-- $X-Y range --></budget_monthly>
    <team_expertise><!-- None | Basic | Intermediate | Expert --></team_expertise>
    <compliance><!-- None | SOC2 | HIPAA | PCI | GDPR --></compliance>
    <availability_target><!-- 99% | 99.9% | 99.99% --></availability_target>
    <geographic_scope><!-- Single | Multi-region | Global --></geographic_scope>
  </requirements_summary>

  <!-- Platform decision with full rationale -->
  <platform_decision>
    <chosen><!-- Chosen platform/combination --></chosen>
    <rationale><!-- Why this platform wins for this project --></rationale>

    <thinking_applied>
      <first_principles><!-- Key insight from decomposition --></first_principles>
      <contrarian><!-- What was rejected and why --></contrarian>
      <user_centric><!-- User experience consideration --></user_centric>
      <systems><!-- Resilience/interaction consideration --></systems>
      <economic><!-- Cost/value consideration --></economic>
    </thinking_applied>

    <alternatives_considered>
      <alternative name="Alternative 1">
        <pros><!-- List advantages --></pros>
        <cons><!-- List disadvantages --></cons>
        <when_to_use><!-- Conditions where this wins --></when_to_use>
      </alternative>
      <alternative name="Alternative 2">
        <pros><!-- List advantages --></pros>
        <cons><!-- List disadvantages --></cons>
        <when_to_use><!-- Conditions where this wins --></when_to_use>
      </alternative>
    </alternatives_considered>
  </platform_decision>

  <!-- Complete deployment architecture -->
  <deployment_architecture>
    <frontend>
      <platform><!-- Vercel | Netlify | CloudFront + S3 | etc --></platform>
      <build_system><!-- Vite | Next.js | etc --></build_system>
      <build_command><!-- npm run build --></build_command>
      <output_directory><!-- dist | .next | build --></output_directory>
      <cdn><!-- Platform CDN | CloudFront | Cloudflare --></cdn>
      <caching_strategy><!-- Immutable assets, dynamic HTML --></caching_strategy>
      <domains>
        <production><!-- app.example.com --></production>
        <staging><!-- staging.example.com --></staging>
      </domains>
    </frontend>

    <backend>
      <platform><!-- Vercel Functions | Railway | ECS | Cloud Run --></platform>
      <runtime><!-- Node.js 20 | Python 3.12 | etc --></runtime>
      <memory><!-- 512MB | 1GB | 2GB --></memory>
      <timeout><!-- 10s | 30s | 300s --></timeout>
      <scaling>
        <min_instances><!-- 0 | 1 --></min_instances>
        <max_instances><!-- 10 | 100 --></max_instances>
        <scale_metric><!-- requests | cpu | memory --></scale_metric>
      </scaling>
      <regions>
        <primary><!-- us-east-1 | iad1 --></primary>
        <secondary><!-- us-west-2 | sfo1 (optional) --></secondary>
      </regions>
    </backend>

    <database>
      <platform><!-- PlanetScale | Neon | RDS | Cloud SQL --></platform>
      <engine><!-- MySQL | PostgreSQL --></engine>
      <version><!-- 8.0 | 15 --></version>
      <tier><!-- Free | Pro | Enterprise --></tier>
      <storage><!-- 5GB | 10GB | 100GB --></storage>
      <connections>
        <max_connections><!-- 100 | 1000 --></max_connections>
        <connection_pooling><!-- enabled | disabled --></connection_pooling>
      </connections>
      <replication>
        <read_replicas><!-- 0 | 1 | 2 --></read_replicas>
        <regions><!-- Same as primary | Multi-region --></regions>
      </replication>
      <backups>
        <frequency><!-- Continuous | Daily | Weekly --></frequency>
        <retention><!-- 7 days | 30 days --></retention>
        <point_in_time><!-- enabled | disabled --></point_in_time>
      </backups>
    </database>

    <cache>
      <platform><!-- Upstash Redis | ElastiCache | None --></platform>
      <type><!-- Redis | Memcached --></type>
      <size><!-- 256MB | 1GB --></size>
      <eviction_policy><!-- allkeys-lru --></eviction_policy>
    </cache>

    <storage>
      <platform><!-- Vercel Blob | S3 | Cloud Storage --></platform>
      <bucket_name><!-- project-assets --></bucket_name>
      <public_access><!-- CDN only | Direct --></public_access>
      <cdn_integration><!-- CloudFront | Platform CDN --></cdn_integration>
    </storage>
  </deployment_architecture>

  <!-- CI/CD pipeline configuration -->
  <ci_cd_pipeline>
    <provider><!-- GitHub Actions | GitLab CI | CircleCI --></provider>

    <triggers>
      <trigger event="push" branch="main">
        <action>deploy to production</action>
      </trigger>
      <trigger event="push" branch="develop">
        <action>deploy to staging</action>
      </trigger>
      <trigger event="pull_request">
        <action>run tests, deploy preview</action>
      </trigger>
    </triggers>

    <stages>
      <stage name="install" duration="1-2min">
        <command>npm ci</command>
        <cache>node_modules</cache>
      </stage>
      <stage name="lint" duration="30s">
        <command>npm run lint</command>
      </stage>
      <stage name="test" duration="2-5min">
        <command>npm test</command>
        <coverage>true</coverage>
      </stage>
      <stage name="build" duration="1-3min">
        <command>npm run build</command>
        <artifacts>dist/</artifacts>
      </stage>
      <stage name="deploy" duration="1-2min">
        <command>platform-specific deploy command</command>
      </stage>
    </stages>

    <environments>
      <environment name="preview">
        <trigger>pull_request</trigger>
        <url_pattern>pr-{number}.preview.example.com</url_pattern>
        <auto_cleanup>true</auto_cleanup>
      </environment>
      <environment name="staging">
        <trigger>develop branch</trigger>
        <url>staging.example.com</url>
        <protection>none</protection>
      </environment>
      <environment name="production">
        <trigger>main branch</trigger>
        <url>app.example.com</url>
        <protection>required_reviewers: 1</protection>
      </environment>
    </environments>

    <secrets_required>
      <secret name="VERCEL_TOKEN" scope="deploy" />
      <secret name="DATABASE_URL" scope="runtime" />
      <secret name="JWT_SECRET" scope="runtime" />
      <secret name="SENTRY_DSN" scope="runtime" />
    </secrets_required>
  </ci_cd_pipeline>

  <!-- Observability configuration -->
  <observability>
    <logging>
      <platform><!-- Vercel Logs | Logtail | CloudWatch --></platform>
      <format>JSON structured</format>
      <retention>
        <searchable><!-- 30 days --></searchable>
        <archive><!-- 90 days --></archive>
      </retention>
      <fields>
        <field required="true">timestamp</field>
        <field required="true">level</field>
        <field required="true">message</field>
        <field required="true">service</field>
        <field required="false">request_id</field>
        <field required="false">user_id</field>
        <field required="false">duration_ms</field>
      </fields>
    </logging>

    <metrics>
      <platform><!-- Vercel Analytics | Datadog | CloudWatch --></platform>
      <custom_metrics>
        <metric name="api_request_duration" type="histogram" />
        <metric name="tasks_created_total" type="counter" />
        <metric name="active_users" type="gauge" />
      </custom_metrics>
      <dashboards>
        <dashboard name="Overview">
          <widget>Request rate</widget>
          <widget>Error rate</widget>
          <widget>p95 latency</widget>
          <widget>Active users</widget>
        </dashboard>
      </dashboards>
    </metrics>

    <tracing>
      <platform><!-- Sentry Performance | Datadog APM | None --></platform>
      <sampling_rate><!-- 0.1 (10%) --></sampling_rate>
      <propagation>W3C Trace Context</propagation>
    </tracing>

    <error_tracking>
      <platform><!-- Sentry --></platform>
      <dsn_secret>SENTRY_DSN</dsn_secret>
      <source_maps>enabled</source_maps>
      <user_context>enabled</user_context>
      <release_tracking>enabled</release_tracking>
    </error_tracking>

    <alerting>
      <channels>
        <channel name="critical" destination="PagerDuty" />
        <channel name="warning" destination="Slack #alerts" />
        <channel name="info" destination="Email digest" />
      </channels>
      <rules>
        <rule name="High Error Rate" severity="critical">
          <condition>error_rate > 5% for 5 minutes</condition>
          <runbook>Check logs for error patterns</runbook>
        </rule>
        <rule name="Slow API" severity="warning">
          <condition>p95_latency > 2s for 10 minutes</condition>
          <runbook>Check database queries and cache</runbook>
        </rule>
        <rule name="Low Disk" severity="warning">
          <condition>disk_usage > 85%</condition>
          <runbook>Clean logs or expand storage</runbook>
        </rule>
      </rules>
    </alerting>

    <uptime_monitoring>
      <platform><!-- Better Uptime | UptimeRobot --></platform>
      <checks>
        <check url="https://app.example.com" interval="1m" />
        <check url="https://api.example.com/health" interval="1m" />
      </checks>
      <status_page><!-- https://status.example.com --></status_page>
    </uptime_monitoring>
  </observability>

  <!-- Security configuration -->
  <security>
    <secrets_management>
      <platform><!-- Vercel Environment Variables | AWS Secrets Manager --></platform>
      <rotation_policy><!-- 90 days --></rotation_policy>
      <access_logging>enabled</access_logging>
    </secrets_management>

    <network>
      <tls_version>1.3</tls_version>
      <hsts>enabled, max-age=31536000</hsts>
      <headers>
        <header name="X-Content-Type-Options">nosniff</header>
        <header name="X-Frame-Options">DENY</header>
        <header name="Referrer-Policy">strict-origin-when-cross-origin</header>
      </headers>
      <csp>default-src 'self'; script-src 'self' 'unsafe-inline'</csp>
      <rate_limiting>100 requests/minute per IP</rate_limiting>
      <ddos_protection><!-- Platform edge network --></ddos_protection>
    </network>

    <authentication>
      <method><!-- JWT with httpOnly cookies --></method>
      <access_token_expiry><!-- 15 minutes --></access_token_expiry>
      <refresh_token_expiry><!-- 7 days --></refresh_token_expiry>
      <password_hashing><!-- bcrypt, cost=12 --></password_hashing>
      <mfa><!-- optional, TOTP --></mfa>
    </authentication>

    <data_protection>
      <encryption_at_rest><!-- AES-256 (platform managed) --></encryption_at_rest>
      <encryption_in_transit><!-- TLS 1.3 --></encryption_in_transit>
      <backup_encryption>enabled</backup_encryption>
      <pii_fields><!-- email, name --></pii_fields>
    </data_protection>

    <compliance>
      <frameworks><!-- GDPR --></frameworks>
      <data_retention><!-- 2 years --></data_retention>
      <deletion_capability><!-- user self-service --></deletion_capability>
      <audit_logging>enabled</audit_logging>
    </compliance>

    <dependency_scanning>
      <tool><!-- Dependabot + npm audit --></tool>
      <schedule><!-- Daily --></schedule>
      <block_on_critical>true</block_on_critical>
    </dependency_scanning>
  </security>

  <!-- Cost analysis -->
  <cost_analysis>
    <executive_summary>
      <recommended_platform><!-- Platform name --></recommended_platform>
      <monthly_range><!-- $X - $Y --></monthly_range>
      <cost_efficiency><!-- Assessment --></cost_efficiency>
    </executive_summary>

    <monthly_estimates>
      <tier name="MVP" dau="100">
        <component name="Hosting">$0</component>
        <component name="Database">$0</component>
        <component name="Monitoring">$0</component>
        <total>$0</total>
        <per_user>$0.00</per_user>
      </tier>
      <tier name="Growth" dau="1000">
        <component name="Hosting">$20</component>
        <component name="Database">$29</component>
        <component name="Monitoring">$0</component>
        <total>$49</total>
        <per_user>$0.049</per_user>
      </tier>
      <tier name="Scale" dau="10000">
        <component name="Hosting">$35</component>
        <component name="Database">$39</component>
        <component name="Monitoring">$26</component>
        <total>$100</total>
        <per_user>$0.01</per_user>
      </tier>
    </monthly_estimates>

    <cost_drivers>
      <driver rank="1"><!-- Primary cost driver --></driver>
      <driver rank="2"><!-- Secondary cost driver --></driver>
      <driver rank="3"><!-- Tertiary cost driver --></driver>
    </cost_drivers>

    <optimization_opportunities>
      <opportunity impact="high">
        <action><!-- Optimization action --></action>
        <savings><!-- Expected savings --></savings>
      </opportunity>
    </optimization_opportunities>

    <break_even_analysis>
      <comparison versus="Alternative">
        <break_even_point><!-- Condition where alternative wins --></break_even_point>
        <rationale><!-- Why --></rationale>
      </comparison>
    </break_even_analysis>
  </cost_analysis>

  <!-- Disaster recovery -->
  <disaster_recovery>
    <rpo><!-- 1 hour | 24 hours --></rpo>
    <rto><!-- 5 minutes | 1 hour --></rto>
    <backup_strategy>
      <database><!-- Continuous | Daily snapshots --></database>
      <files><!-- Versioned object storage --></files>
      <configuration><!-- Git-tracked IaC --></configuration>
    </backup_strategy>
    <failover_procedure>
      <step order="1"><!-- First step --></step>
      <step order="2"><!-- Second step --></step>
      <step order="3"><!-- Third step --></step>
    </failover_procedure>
    <testing>
      <frequency><!-- Quarterly --></frequency>
      <last_tested><!-- YYYY-MM-DD --></last_tested>
    </testing>
  </disaster_recovery>
</infrastructure_specification>
